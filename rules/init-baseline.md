# 初始化基线分析执行步骤

> 侧重：建立全景基线 + 识别方法论演进轨迹。目标是让用户看到"从哪里来、现在在哪、下一步往哪走"。

## 输入

- 全部已有 session 的 facet（.retro/facets/ 下所有文件）
- 项目目录产出物清单

## 执行：两阶段分析

### 阶段 A: 结构化提取（子智能体并行）

> 加载 [_shared/subagent-protocol.md](_shared/subagent-protocol.md) 执行。

用子智能体批量提取 facet 后，做以下聚合：

**1. 基础统计**

运行聚合脚本获取结构化统计数据：
```bash
python3 "$MADNESS_DIR"/scripts/aggregate_facets.py --retro-dir .retro
```
→ 输出 JSON 含：by_goal_category、by_outcome、by_date、friction_top5、loop_rate、loop_sessions、ai_collab_summary、tools_distribution、avg_duration_min、total_files_changed

子智能体基于脚本输出做解读和模式识别（脚本只做计数，不做归因）。

**2. 时间线重建**
```
- 按日期排列所有 session，识别项目阶段
  （探索期 → 方法论收敛 → 执行期 → 产出期 → 校准期）
- 标注阶段转折点（哪个 session 触发了方法论变化）
```

**3. 产出盘点**

使用 Glob 扫描项目目录，盘点全部产出物：
- 扫描项目根目录（排除 .git、.retro、node_modules、__pycache__、.venv）
- 按类型分类（报告 .md/.txt、数据 .json/.csv、工具 .py/.ts、可视化 .png/.svg/.html、文档 .doc/.pptx）
- 统计文件数量和总大小

注意：init 模式扫描全部文件（无日期过滤）。

### 阶段 B: 深度归因分析（子智能体并行）

**基于阶段 A 的发现，回到原始会话数据做深度追溯。**

对每个子智能体的 Prompt 必须要求：

```
1. 对每个返工循环：
   - 引用触发返工的用户原话
   - 分析根因（标准没定义？理解偏差？数据不准？）
   - 返工花了几轮才收敛
   - 如果当时做了什么不同的事，可以避免

2. 对每个摩擦点：
   - 举出具体的会话场景和用户原话
   - 分析根本原因（不是表面原因）

3. 对方法论演进：
   - 追溯用户的指令风格变化（从"给我分析"到"统计多少人"）
   - 标注每次变化的触发事件

4. 对每条改进建议：
   - 必须给出可执行的步骤（Step 1 → Step 2 → Step 3）
   - 必须给出检查点（怎么判断做对了）
   - 必须给出预期效果（量化的或可观察的）

5. 对 AI 协作 + 执行质量审计：
   > 加载 [_shared/ai-audit.md](_shared/ai-audit.md) 执行。
   - 输出：初期 AI 协作模式 vs 后期变化
   - 输出：AI 执行问题清单（优先于用户行为问题展示）
```

## 输出：摘要（≤500 字，先展示）

```markdown
## [项目名] 基线摘要
**总 session**：N | **达成率**：X% | **循环率**：Y%
**一句话诊断**：[最核心的方法论发现]
**关键行动**：1. [...] 2. [...]
> 输入「展开详情」查看完整基线报告。
```（end template）

## 输出：基线报告详情（用户要求时展示）

按以下结构生成，**每个部分都必须有具体证据，不说空话**：

```markdown
# [项目名] — 初始化基线报告

<!-- grai:goal-review start -->
## 零、目标确认
（init 模式下是首次目标确认，不是回顾变更）

| 目标 | 优先级 | 成功标准 | 初始状态 |
|------|--------|---------|---------|
（从 state.json goals 填入，status 均为 not_started）

**目标完备性检查**：
- 是否所有目标都有量化的 success_criteria？（如有缺失，在此标注）
- 目标之间是否有依赖或冲突关系？
- 按当前 session 数据，初步预判各目标的可行性
<!-- grai:goal-review end -->

## 一、项目全景
- 基础统计表（会话数、消息数、达成率、循环率）
- 产出清单

## 二、项目阶段演进时间线
对每个阶段：
- 核心活动
- 典型摩擦（带用户原话引用）
- 关键返工案例（带完整时间线：触发→根因→收敛轮数→避免策略）
- 用户的自我进化（行为变化 + 原话证据）

## 三、摩擦根因深度分析
对 Top 3-5 摩擦：
- 不只是说"分类模糊"，要列出具体哪些分类对混淆了、用户怎么解决的
- 不只是说"规划不足"，要说具体缺了什么（分类标准？输出格式？统计口径？）
- 每个摩擦必须给出具体改进 SOP（含步骤+检查清单）

## 四、最佳实践详解
对每条已沉淀的实践：
- 适用场景 + 具体做法 + 不适用场景
- 推导过程（从哪个踩坑学到的）
- 可执行的 SOP

## 五、改进路线图
对每条改进：
- 现状描述（具体场景）
- 改进方案（具体步骤 + 检查点）
- 预期效果（量化）

## 六、如果重新开始的最优工作流
- 具体 Phase 划分
- 每个 Phase 的步骤/交付物/检查点
- 效率对比（当前 vs 改进后）

## 七、基线指标
- 关键指标表（含改进目标值）
```

## 质量门控（展示前必须通过，不可跳过）

> 加载 [_shared/quality-gate.md](_shared/quality-gate.md) 执行。

init 模式额外自检项：
- [ ] 方法论演进有"从→经过→到"的完整轨迹？
- [ ] 最佳实践有推导过程（不是突然冒出的结论）？
- [ ] "如果重新开始"部分有具体 Phase+步骤+检查点？
